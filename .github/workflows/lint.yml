name: Code Quality & Linting

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npx eslint src/ --ext .js,.jsx,.ts,.tsx --max-warnings 0

      - name: Check code formatting
        run: npx prettier --check src/

  lint-backend:
    name: Lint Backend  
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint (if configured)
        run: npx eslint . --ext .js --max-warnings 0 || echo "ESLint not configured, skipping..."

      - name: Check code formatting
        run: npx prettier --check . || echo "Prettier not configured, skipping..."

  validate-workflows:
    name: Validate GitHub Actions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate workflow syntax
        run: |
          # Basic YAML syntax validation
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              python -c "
              import yaml, sys
              try:
                  with open('$file', 'r') as f:
                      yaml.safe_load(f)
                  print('‚úÖ $file is valid YAML')
              except Exception as e:
                  print('‚ùå $file has YAML syntax errors:', e)
                  sys.exit(1)
              "
            fi
          done

      - name: Check workflow best practices
        run: |
          echo "üîç Checking GitHub Actions best practices..."
          
          # Check for pinned action versions
          if grep -r "uses:.*@main\|uses:.*@master" .github/workflows/; then
            echo "‚ö†Ô∏è Warning: Consider pinning actions to specific versions instead of @main/@master"
          fi
          
          # Check for secrets usage
          if grep -r "secrets\." .github/workflows/; then
            echo "‚úÖ Secrets usage detected - ensure they are properly configured"
          fi
          
          echo "‚úÖ Workflow validation completed"
